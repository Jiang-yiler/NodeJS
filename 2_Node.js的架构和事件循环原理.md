## Node.jsçš„æ¶æ„
ä½œä¸ºä¸€ä¸ªæœåŠ¡ç«¯æ¡†æ¶ï¼Œ`Node.js`åœ¨è¿è¡Œæ—¶æœ‰è®¸å¤šä¾èµ–ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªæ˜¯`V8`å¼•æ“å’Œ`libuv`åº“
- **`V8`å¼•æ“**ä½¿å¾—`Node.js`èƒ½å¤Ÿè¿è¡Œ`JavaScript`ä»£ç ï¼Œæ˜¯ç”¨`JavaScript`å’Œ`C++`å¼€å‘çš„
- **`libuv`åº“**ä½¿å¾—`Node.js`èƒ½å¤Ÿè¿›è¡Œæ–‡ä»¶æ“ä½œã€ç½‘ç»œæ“ä½œç­‰ï¼Œæ˜¯ç”¨`C++`å¼€å‘çš„ã€‚å…¶å†…éƒ¨å®ç°äº†äº‹ä»¶å¾ªç¯å’Œçº¿ç¨‹æ± ï¼š
    - **äº‹ä»¶å¾ªç¯**è´Ÿè´£å¤„ç†ç®€å•çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æ‰§è¡Œå›è°ƒå‡½æ•°ã€ç½‘ç»œ`IO`ç­‰
    - **çº¿ç¨‹æ± **è´Ÿè´£å¤„ç†æ›´åŠ å¤æ‚çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æ–‡ä»¶è®¿é—®ã€å‹ç¼©ç­‰

- å…¶å®ƒä¾èµ–
    - `http-parser`ï¼šç”¨äºè§£æ`http`è¯·æ±‚å’Œå“åº”
    - `c-ares`ï¼šå¼‚æ­¥`DNS`è§£æåº“ï¼Œå¯ä»¥å’Œäº‹ä»¶å¾ªç¯ç»Ÿä¸€èµ·æ¥ï¼Œå®ç°`DNS`çš„éé˜»å¡å¼‚æ­¥è§£æ
    - `crypto(OpenSSL)`ï¼šç”¨äºå®ç°å®‰å…¨é€šä¿¡ï¼ŒåŠ å¯†è§£å¯†
    - `zlib`ï¼šç”¨äºå‹ç¼©å’Œè§£å‹ç¼©


## Node è¿›ç¨‹ï¼Œçº¿ç¨‹å’Œçº¿ç¨‹æ± 
å½“æˆ‘ä»¬è¿è¡Œ`Node.js`æ—¶ï¼Œè®¡ç®—æœºåå°ä¾¿ä¼šå¼€å¯ä¸€ä¸ª`Node.js`çš„è¿›ç¨‹ï¼ˆ`Node.js`æœ¬èº«ä¹Ÿæä¾›äº†ç”¨äºè¿›ç¨‹ç®¡ç†çš„APIï¼‰

ä¸æ­¤åŒæ—¶ï¼Œ`Node.js`çš„è¿è¡Œæ˜¯å•çº¿ç¨‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡æœ‰å¤šå°‘ç”¨æˆ·åœ¨è®¿é—®åº”ç”¨ç¨‹åºï¼Œæ‰€æœ‰æŒ‡ä»¤éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè¿™ä½¿å¾—å®ƒéå¸¸å®¹æ˜“è¢«å µå¡ã€‚å…·ä½“æ¥è¯´ï¼Œå½“`Node.js`è¢«å¯åŠ¨æ—¶ï¼Œä¼šåœ¨å•çº¿ç¨‹ä¸­ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

**åˆå§‹åŒ–é¡¹ç›®ğŸ‘‰æ‰§è¡Œé¡¶å±‚ä»£ç ï¼ˆä¸åœ¨å›è°ƒå‡½æ•°ä¸­ï¼‰ğŸ‘‰åŠ è½½æ¨¡å—ğŸ‘‰æ³¨å†Œå›è°ƒå‡½æ•°ğŸ‘‰å¼€å¯äº‹ä»¶å¾ªç¯ï¼ˆå›è°ƒå‡½æ•°ä¸­ï¼‰**

- å…¶ä¸­ï¼Œäº‹ä»¶å¾ªç¯æ‰›èµ·äº†ä¸€ç‰‡å¤©ï¼Œä¼šæ‰§è¡Œç¨‹åºä¸­çš„å¤§éƒ¨åˆ†ä»»åŠ¡ï¼Œä½†æœ‰äº›ä»»åŠ¡ç¡®å®è¿‡äºå¤æ‚ï¼Œå¦‚æœåœ¨äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œï¼Œå°±ä¼šé˜»å¡æ•´ä¸ªçº¿ç¨‹ã€‚time for çº¿ç¨‹æ± 
- çº¿ç¨‹æ± æä¾›äº†4ä¸ªä¸ä¸»çº¿ç¨‹å®Œå…¨åˆ†å¼€çš„çº¿ç¨‹ï¼Œäº‹ä»¶å¾ªç¯åœ¨é‡åˆ°è¯¸å¦‚**æ–‡ä»¶ã€å¯†ç ã€å‹ç¼©ã€DNSæŸ¥è¯¢ç­‰å¤æ‚æ“ä½œ**æ—¶ï¼Œå°±ä¼šå°†è¿™äº›ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± 

## äº‹ä»¶å¾ªç¯
### æ–‡

å¦‚æœè¦ç”¨ä¸€å¥è¯æ¦‚æ‹¬äº‹ä»¶å¾ªç¯çš„ä½œç”¨ï¼ŒæŒ‰æˆ‘çš„ç†è§£å°±æ˜¯**äº‹ä»¶å¾ªç¯ä¼šæ¥æ”¶äº‹ä»¶ã€æ‰§è¡Œæ‰€æœ‰åœ¨å›è°ƒå‡½æ•°ä¸­çš„ä»£ç ï¼Œå¹¶å°†å¤æ‚çš„ä»»åŠ¡äº¤ä»˜ç»™çº¿ç¨‹æ± **

äº‹ä»¶å¾ªç¯æœ‰å¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªå›è°ƒå‡½æ•°é˜Ÿåˆ—ï¼Œå…¶ä¸­**å››ä¸ªé‡è¦çš„é˜¶æ®µ**ï¼š
1. æ™®é€šè®¡æ—¶å™¨é˜¶æ®µï¼š`setTimeout()`ç­‰
2. `I/O`ä»»åŠ¡é˜¶æ®µï¼š`http()`ï¼Œ`fs()`ç­‰æ–‡ä»¶å’Œç½‘ç»œå¤„ç†ç›¸å…³
3. ç‰¹æ®Šè®¡æ—¶å™¨é˜¶æ®µï¼š`setImmediate()`
4. `close`é˜¶æ®µï¼šå¦‚å…³é—­`Web Server`ã€`WebSocket`æ—¶è§¦å‘çš„å›è°ƒå‡½æ•°

ä»¥åŠ**ä¸¤ä¸ªç‰¹æ®Šçš„å›è°ƒé˜Ÿåˆ—**ï¼š
1. `process.nextTick()`çš„å›è°ƒï¼šéœ€è¦åœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸä¹‹å**ç«‹å³æ‰§è¡Œ**æŸä¸ªç‰¹å®šå›è°ƒæ—¶ä½¿ç”¨ï¼Œç±»ä¼¼`setImmediate()`ï¼Œä¸åŒçš„æ˜¯`setImmediate()`æ˜¯åœ¨æ–‡ä»¶å’Œç½‘ç»œå¤„ç†ä¹‹åæ‰§è¡Œ
2. å…¶å®ƒå¾®ä»»åŠ¡çš„å›è°ƒï¼ˆResolved promisesï¼‰

**ä¸Šé¢çš„åºå·å³è¡¨ç¤ºæ‰§è¡Œçš„ä¼˜å…ˆçº§**

**é‡è¦é˜¶æ®µçš„å›è°ƒ**ï¼Œä»¥`setTimeout()`ä¸ºä¾‹ï¼Œå½“äº‹ä»¶å¾ªç¯åˆ°äº†æ™®é€šå®šæ—¶å™¨é˜¶æ®µï¼Œå¦‚æœæ­¤æ—¶è®¡æ—¶ç»“æŸäº†ï¼Œä¼šç«‹å³æ‰§è¡Œ`setTimeout()`ä¸­çš„å›è°ƒå‡½æ•°ï¼›å¦‚æœæ²¡æœ‰ç»“æŸï¼Œäº‹ä»¶å¾ªç¯ä¼šç»§ç»­åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œè€Œä¸”åœ¨è¿™æ¬¡`circle`ä¸­ä¸ä¼šå†æ‰§è¡Œè¿™ä¸ªå®šæ—¶å™¨ä¸­çš„å›è°ƒï¼Œå°±ç®—åœ¨è¿™æœŸé—´è®¡æ—¶ç»“æŸäº†ã€‚ç›´åˆ°ä¸‹æ¬¡è¿›å…¥å®šæ—¶å™¨é˜¶æ®µå†æ‰§è¡Œã€‚

è€Œé‚£ä¸¤ä¸ª**ç‰¹æ®Šçš„å›è°ƒé˜Ÿåˆ—**ï¼Œä»¥`process.nextTick()`ä¸ºä¾‹ï¼Œè™½ç„¶åç§°å«`nextTick`ï¼Œä½†`process.nextTick()`ä¸­çš„å›è°ƒå¹¶ä¸ä¼šåœ¨ä¸‹ä¸€ä¸ª`tick`ä¸­æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨å½“å‰é˜¶æ®µï¼ˆ`parse`ï¼‰ç»“æŸåç«‹å³æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚äº‹ä»¶å¾ªç¯æ‰§è¡Œåˆ°äº†`I/O`äº‹ä»¶é˜¶æ®µï¼Œæ­¤æ—¶æœ‰`process.nextTick()`ä¸­çš„å›è°ƒéœ€è¦æ‰§è¡Œï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œå®Œå½“å‰`I/O`äº‹ä»¶çš„å›è°ƒä¹‹åä¾¿ä¼šç«‹å³æ‰§è¡Œ`process.nextTick()`ä¸­çš„å›è°ƒï¼Œä¹‹åå†æ‰§è¡Œç‰¹æ®Šè®¡æ—¶å™¨çš„å›è°ƒã€‚

é‚£ä¹ˆ`Node.js`æ˜¯å¦‚ä½•åˆ¤æ–­äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ª`circle`æ˜¯å¦ç»“æŸçš„ï¼Ÿåœ¨æ‰§è¡Œå®Œ`close`é˜¶æ®µçš„å›è°ƒå‡½æ•°åï¼ŒNode.jsä¼šæ£€æŸ¥æ˜¯å¦æœ‰è¿˜åœ¨è®¡æ—¶çš„å®šæ—¶å™¨æˆ–`I/O`ä»»åŠ¡ï¼Œå¦‚æœè¿˜æœ‰é‚£å°±è¿›è¡Œäº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€è½®`circle`ï¼›å¦‚æœæ²¡æœ‰å°±ç›´æ¥é€€å‡ºäº‹ä»¶å¾ªç¯ï¼Œä¹Ÿå°±é€€å‡º`Node.js`çš„ç¨‹åºäº†

### å›¾
ä¸ºäº†æ›´åŠ ç›´è§‚ï¼Œæˆ‘å°†ä¸Šé¢å™è¿°çš„**ä»`Node.js`ç¨‹åºå¯åŠ¨åˆ°é€€å‡º**çš„æ•´ä¸ªè¿‡ç¨‹ä¾ç…§ä¸ªäººçš„ç†è§£ç»˜åˆ¶æˆäº†æµç¨‹å›¾ï¼š


![demo-äº‹ä»¶å¾ªç¯.jpg](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/903bbedec28c4c6da5e612bac44ce316~tplv-k3u1fbpfcp-watermark.image?)


### ä»£ç 
**åˆæ¥ä¹åˆ°**ï¼Œå…ˆçœ‹ä¸€æ®µä»£ç çƒ­çƒ­èº«


```javascript
const fs = require("fs");

setTimeout(() => {console.log("Timer 1 finished"), 0;});

setImmediate(() => {console.log("Immediate 1 finished"); });

fs.readFile("test-file.text", () => {console.log("I/O finished"); });

console.log("Hello from the top-level code"); 

```
ä»¥ä¸Šä»£ç è¾“å‡ºç»“æœï¼š
```
// node 10.15.2
Hello from the top-level code
Timer 1 finished
Immediate 1 finished
I/O finished
```

æœ‰çš„äººå¯èƒ½è¿è¡Œçš„ç»“æœæ˜¯
```
// node 10.15.2
Hello from the top-level code
Timer 1 finished
Immediate 1 finished
I/O finished
```

ç©¶å…¶åŸå› ï¼Œéœ€è¦è¡¥å……ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š**`Node.js`ä¼šæŠŠ`setTimeout(fn, 0)`å¼ºåˆ¶æ”¹ä¸º`setTimeout(fn, 1)`**ï¼Œ[å®˜æ–¹æ–‡æ¡£](https://nodejs.org/api/timers.html#settimeoutcallback-delay-args)æœ‰ä»‹ç»ï¼Œè¿™æ˜¯æºç å†³å®šçš„ã€‚æ‰€ä»¥å…³é”®å°±åœ¨è¿™ä¸ª`1ms`ç§’ï¼Œå¦‚æœåŒæ­¥ä»£ç æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¿›å…¥`æ™®é€šå®šæ—¶å™¨`é˜¶æ®µæ—¶`1ms`å·²ç»è¿‡äº†ï¼Œé‚£ä¹ˆ`setTimeout`æ‰§è¡Œï¼Œå¦åˆ™å°±å…ˆæ‰§è¡Œäº†`setImmediate`ã€‚æ¯æ¬¡æˆ‘ä»¬è¿è¡Œè„šæœ¬æ—¶ï¼Œæœºå™¨çŠ¶æ€å¯èƒ½ä¸ä¸€æ ·ï¼Œå¯¼è‡´è¿è¡Œæ—¶æœ‰`1ms`çš„å·®è·

ä¸‹é¢å†**å°è¯•ç‰›åˆ€**ä¸€ä¸‹

```javascript
const fs = require("fs");

setTimeout(() => {console.log("Timer 1 finished"), 0;});

setImmediate(() => {console.log("Immediate 1 finished");});

fs.readFile("test-file.text", () => {
  console.log("I/O finished"); 
  console.log("-------"); // æ–¹ä¾¿ç›´è§‚çš„åŒºåˆ†
  setTimeout(() => {console.log("Timer 2 finished"), 0;});
  setTimeout(() => { console.log("Timer 3 finished"), 3000;});
  setImmediate(() => {console.log("Immediate 2 finished");});
  process.nextTick(() => { console.log("Process.nextTick");});
});

console.log("Hello from the top-level code"); // åŒæ­¥ä»£ç 

```
ä¸ç¬¬ä¸€æ®µä»£ç ç›¸æ¯”ï¼Œåœ¨`fs.readFile`ä¸­å¢åŠ äº†ä¸‰ä¸ªå®šæ—¶å™¨å’Œä¸€ä¸ª`process.nextTick`ï¼Œè¾“å…¥ç»“æœå¦‚ä¸‹ï¼š
```
Hello from the top-level code
Timer 1 finished
Immediate 1 finished
I/O finished
-------
Process.nextTick
Immediate 2 finished
Timer 2 finished
Timer 3 finished
```
`---`ä¸Šæ–¹çš„è¾“å‡ºä¸ä¹‹å‰çš„ä¸€æ ·ï¼Œåœ¨è¿›å…¥`fs.readFile`çš„å›è°ƒåé‡åˆ°`process.nextTick`ä¼šç«‹é©¬æ‰§è¡Œï¼Œä¹‹åå†ç»§ç»­æ‰§è¡Œå…¶å®ƒå†…å®¹ï¼Œåœ¨è¿›å…¥`å®šæ—¶å™¨é˜¶æ®µ`æ—¶ï¼Œ`Timer 3`è¿˜å¤„äº`pending`çš„çŠ¶æ€ï¼Œå› æ­¤åªèƒ½åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­æ‰§è¡Œï¼Œè‡³äº `setImmediate`å…ˆäº`setTimeout`æ‰§è¡Œï¼Œæ˜¯å› ä¸ºåœ¨è½®è¯¢æ—¶å‘ç°æœ‰`setImmediate`å°±ä¼šæ‰§è¡Œ`setImmediate`ä¸­çš„å›è°ƒ


## æ€»ç»“
- äº‹ä»¶å¾ªç¯ä¼šæ‰§è¡Œæ‰€æœ‰åœ¨å›è°ƒå‡½æ•°ä¸­çš„ä»£ç ï¼Œå¹¶å°†å¤æ‚çš„ä»»åŠ¡äº¤ä»˜ç»™çº¿ç¨‹æ± 
- åœ¨åŒä¸€ä¸ªå¼‚æ­¥å›è°ƒä¸­ï¼Œ`setImmediate`æ€»æ˜¯æ¯”`setTimeout(fn, 0)`å…ˆæ‰§è¡Œï¼›å¦‚æœéƒ½åœ¨é¡¶å±‚ä»£ç æˆ–è€…`setImmediate`å›è°ƒé‡Œï¼Œæ‰§è¡Œçš„é¡ºåºå–å†³äºå½“æ—¶æœºå™¨çš„çŠ¶å†µ
- `process.nextTick`å’Œ`setImmediate`çš„åå­—åº”è¯¥äº’æ¢ä¸€ä¸‹ï¼Œè¿™æ ·æ‰ä¸å®ƒä»¬å®é™…çš„æ‰§è¡Œæœºåˆ¶ç›¸ç¬¦ï¼Œå› ä¸º`setImmediate`å®é™…ä¸Šåœ¨ä¸‹ä¸€ä¸ªå¾ªç¯æ‰§è¡Œï¼Œ`nextTick`å®é™…ä¸Šæ˜¯é©¬ä¸Šæ‰§è¡ŒğŸ¤”ğŸ¤”ğŸ¤”


## åç»­
éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæœ¬æ–‡ä¸­æ‰€æœ‰ä»£ç è¿è¡Œç¯å¢ƒçš„`node 10.15.3`ï¼Œ`node 11`ä¹‹åï¼Œå…¶äº‹ä»¶å¾ªç¯çš„åŸç†æ¸æ¸å‘æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªç¯é æ‹¢ï¼Œæ¯”å¦‚é‡è¦é˜¶æ®µçš„åˆ’åˆ†ã€å¾®ä»»åŠ¡çš„æ‰§è¡Œç­‰ã€‚å› æ­¤æœ¬æ–‡ç›®å‰åªæ˜¯ä¸€ä¸ªå¼•å­ï¼Œåç»­æ‰“ç®—åˆ†ä¸‰ä¸ªé˜¶æ®µå†å¯¹æ–‡ç« ä½œæŒç»­è¡¥å……ï¼š

1. `node 11` å‰åäº‹ä»¶å¾ªç¯åŸç†çš„å˜åŒ–ä»¥åŠæœ€æ–°çš„æ ‡å‡†ï¼Œæ¯”å¦‚`pharse`çš„åˆ’åˆ†å’Œ`process.nextTick`çš„æ‰§è¡Œé¡ºåº
2. æµè§ˆå™¨ä¸­çš„`JavaSsript`å¼•æ“çº¿ç¨‹å’Œäº‹ä»¶å¾ªç¯åŸç†
3. äº‹ä»¶å¾ªç¯æ¡ˆä¾‹å®è·µ



å‚è€ƒèµ„æ–™ï¼š

[The Node.js Event Loop, Timers, and process.nextTick() | Node.js (nodejs.org)](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)

[Node.js event loop workflow & lifecycle in low level (voidcanvas.com)](https://www.voidcanvas.com/nodejs-event-loop/)

[Node äº‹ä»¶å¾ªç¯æœºåˆ¶ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844904137662922760)

[å‰–ænodejsçš„äº‹ä»¶å¾ªç¯ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844903621444763662#heading-5)